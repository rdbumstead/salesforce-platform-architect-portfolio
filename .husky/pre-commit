#!/bin/sh
# ----------------------
# INTELLIGENT HOOK
# ----------------------

# 1. HYGIENE (Handled by lint-staged in package.json)
# Runs: Prettier, ESLint, Secret Lint, and LWC Jest (Related Files Only)
echo "[INFO] [1/2] Running Hygiene Checks (Lint/Secrets/UI Tests)..."
npm run precommit
if [ $? -ne 0 ]; then echo "[ERROR] Hygiene Failed"; exit 1; fi

# ----------------------
# 2. BACKEND VALIDATION (Conditional)
# ----------------------
# Trigger: Apex, Objects, Permissions, or Project Config
# NOTE: Uses single quotes to preserve regex backslashes
BACKEND_PATTERN='\.\(cls\|trigger\|object\|field\|permissionset\|profile\|flow\|rule\)-meta\.xml\|\.cls$\|\.trigger$\|sfdx-project\.json'

# Get list of STAGED files
STAGED_FILES=$(git diff --cached --name-only)

if echo "$STAGED_FILES" | grep -q "$BACKEND_PATTERN"; then
  echo "[INFO] [2/2] Backend Changes Detected: Validating against Salesforce..."
  echo "       (This ensures your Apex/Metadata compiles before commit)"
  
  # Ensure target org is set
  # We check for "value" in the JSON output to ensure a target is actually configured
  if ! sf config get target-org --json | grep -q "value"; then
     echo "[ERROR] No default org set. Run 'sf config set target-org=YOUR_ALIAS' first."
     exit 1
  fi

  # Run the validation
  # This uses your package.json script: "sf project deploy validate --source-dir packages --test-level RunLocalTests"
  npm run sf:validate
  if [ $? -ne 0 ]; then echo "[ERROR] Salesforce Validation Failed"; exit 1; fi
else
  echo "[SKIP] [2/2] Backend Unchanged: Skipping Salesforce Validation."
fi

echo "[SUCCESS] Quality Gate Passed. Committing..."
exit 0