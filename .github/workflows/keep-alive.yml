name: Daily Org Heartbeat

on:
  schedule:
    # Runs daily at 08:00 UTC
    - cron: "0 8 * * *"
  workflow_dispatch:

jobs:
  heartbeat:
    name: Salesforce Org Heartbeat
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Salesforce CLI
        uses: ./.github/actions/setup-sf
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_INTEGRATION_USERNAME }}
          install_code_analyzer: false

      - name: Execute Heartbeat Query
        run: |
          echo "Running org heartbeat query..."
          sf data query \
            --query "SELECT Id FROM User LIMIT 1" \
            --target-org portfolio

      - name: Ensure Portfolio Owner Is Unfrozen
        continue-on-error: true
        run: |
          echo "Generating Apex recovery script..."

          cat <<EOF > unfreeze_owner.apex
          try {
              String targetUsername = '${{ secrets.SFDX_USERNAME }}';
              System.debug('Heartbeat recovery for user: ' + targetUsername);

              List<User> users = [SELECT Id FROM User WHERE Username = :targetUsername LIMIT 1];

              if (users.isEmpty()) {
                  System.debug('WARN: Target user not found.');
                  return;
              }

              List<UserLogin> logins = [SELECT Id, IsFrozen FROM UserLogin WHERE UserId = :users[0].Id LIMIT 1];
              
              if (!logins.isEmpty()) {
                  SObject genericUl = (SObject)logins[0];
                  
                  if ((Boolean)genericUl.get('IsFrozen')) {
                      genericUl.put('IsFrozen', false);
                      
                      update genericUl;
                      System.debug('SUCCESS: User was unfrozen.');
                  } else {
                      System.debug('INFO: User already active.');
                  }
              }

          } catch (Exception e) {
              System.debug('WARNING: Unable to unfreeze user. Error: ' + e.getMessage());
          }
          EOF

          echo "Executing Apex recovery..."
          sf apex run --file unfreeze_owner.apex --target-org portfolio || true
