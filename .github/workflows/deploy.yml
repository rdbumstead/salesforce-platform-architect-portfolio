name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - "packages/**"
      - "!packages/integration-api/specs/**"
      - "!packages/integration-api/AnypointStudio/**"
      - "!packages/**/*.md"
      - "!packages/**/jsconfig.json"
      - "!packages/**/.gitkeep"
      - "sfdx-project.json"
      - "package.json"
      - "package-lock.json"
      - "scripts/**"
      - ".github/workflows/deploy.yml"
      - ".github/actions/**"
  workflow_dispatch:
    inputs:
      deployment_mode:
        description: "Deployment Mode"
        required: true
        default: "delta"
        type: choice
        options: [delta, full]
      destructive_timing:
        description: "Destructive Changes Timing"
        required: true
        default: "post"
        type: choice
        options: [pre, post]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Salesforce & Tools
        uses: rdbumstead/setup-salesforce-action@v1
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_USERNAME }}
          install_delta: "true"

      - name: Generate Delta
        if: github.event_name == 'push' || github.event.inputs.deployment_mode == 'delta'
        run: |
          mkdir -p changed
          FROM_SHA="${{ github.event.before }}"
          [ -z "$FROM_SHA" ] || [ "$FROM_SHA" = "0000000000000000000000000000000000000000" ] && FROM_SHA="HEAD~1"
          sf sgd source delta --to "HEAD" --from "$FROM_SHA" --output changed --source packages --generate-delta

      - name: Execute Deployment
        run: |
          if [ "${{ github.event.inputs.deployment_mode }}" == "full" ]; then
            sf project deploy start --source-dir packages --target-org portfolio --wait 60
          elif { [ -s changed/package/package.xml ] && grep -q "<types>" changed/package/package.xml; } || { [ -s changed/destructiveChanges/destructiveChanges.xml ] && grep -q "<types>" changed/destructiveChanges/destructiveChanges.xml; }; then
            DESTRUCTIVE_FLAG="--post-destructive-changes"
            if [ "${{ github.event.inputs.destructive_timing }}" == "pre" ]; then
               DESTRUCTIVE_FLAG="--pre-destructive-changes"
            fi

            sf project deploy start --manifest changed/package/package.xml $DESTRUCTIVE_FLAG changed/destructiveChanges/destructiveChanges.xml --target-org portfolio --wait 30
          else
            echo "No metadata changes detected."
          fi
