name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"

jobs:
  validate-scratch-org:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # ------------------------------------------------------------------
      # 1. Setup Node and Run LWC Tests
      # ------------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install NPM Dependencies
        run: npm ci

      - name: Run LWC Jest Tests
        run: npm run test:unit

      # ------------------------------------------------------------------
      # 2. Salesforce CLI & Code Analyzer
      # ------------------------------------------------------------------
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install Code Analyzer
        run: sf plugins install @salesforce/plugin-code-analyzer

      - name: Authenticate Dev Hub
        run: |
          echo "${{ secrets.SFDX_JWT_KEY }}" > portfolio.key
          sf org login jwt \
            --client-id ${{ secrets.SFDX_CLIENT_ID }} \
            --jwt-key-file portfolio.key \
            --username ${{ secrets.SFDX_USERNAME }} \
            --set-default-dev-hub \
            --alias devhub

      # ------------------------------------------------------------------
      # 3. Static Analysis
      # ------------------------------------------------------------------

      - name: Run Salesforce Code Analyzer
        shell: bash
        run: npm run scan

      # ------------------------------------------------------------------
      # 4. Scratch Org Execution (With Limit Fallback)
      # ------------------------------------------------------------------
      - name: Create Scratch Org or Fallback
        id: create_org
        run: |
          echo "ORG_TYPE=scratch" >> $GITHUB_ENV

          set +e
          OUTPUT=$(sf org create scratch \
            --target-dev-hub devhub \
            --definition-file config/project-scratch-def.json \
            --alias ci-org \
            --duration-days 1 \
            --set-default \
            --no-ancestors \
            --wait 30 \
            --json 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            if echo "$OUTPUT" | grep -q "LimitExceeded"; then
               echo "Scratch Org limit reached. Switching to Dev Hub Validation Mode."
               echo "ORG_TYPE=fallback" >> $GITHUB_ENV
            else
               echo "Error creating scratch org:"
               echo "$OUTPUT"
               exit 1
            fi
          else
             echo "Scratch org created successfully."
          fi

      - name: Deploy Core Metadata (Scratch Only)
        if: env.ORG_TYPE == 'scratch'
        run: |
          sf project deploy start \
            --source-dir packages/shared-modules/main/default \
            --source-dir packages/integration-api/main/default \
            --source-dir packages/portfolio-site/main/default \
            --target-org ci-org \
            --wait 30

      - name: Deploy Configuration Metadata (Scratch Only)
        if: env.ORG_TYPE == 'scratch'
        run: |
          PERMSET_COUNT=$(find packages -name "*.permissionset-meta.xml" 2>/dev/null | wc -l)

          if [ "$PERMSET_COUNT" -gt 0 ]; then
            echo "Found $PERMSET_COUNT permission set(s) to deploy"
            sf project deploy start \
              --metadata PermissionSet \
              --target-org ci-org \
              --ignore-warnings \
              --wait 30
          else
            echo "No permission sets to deploy"
          fi
        continue-on-error: true

      - name: Verify Core Deployment (Scratch Only)
        if: env.ORG_TYPE == 'scratch'
        run: |
          echo "=== Deployed Apex Classes ==="
          sf org list metadata --metadata-type ApexClass --target-org ci-org
          echo "=== Deployed LWC Components ==="
          sf org list metadata --metadata-type LightningComponentBundle --target-org ci-org

      # ------------------------------------------------------------------
      # 5. Quality Gates (Apex Tests)
      # ------------------------------------------------------------------
      - name: Run Apex Tests (Scratch Org Mode)
        if: env.ORG_TYPE == 'scratch'
        run: |
          set +e

          # Run Apex tests and capture output
          sf apex run test \
            --target-org ci-org \
            --code-coverage \
            --json \
            --wait 10 > test-result.json

          TEST_EXIT_CODE=$?
          set -e

          echo "=== Test Results JSON ==="
          cat test-result.json
          echo "========================="

          COVERAGE=$(jq -r '.result.summary.testRunCoverage // 0' test-result.json | tr -d '%')
          COVERAGE_ROUNDED=$(printf "%.0f" "$COVERAGE")

          echo "Measured Code Coverage: $COVERAGE_ROUNDED%"

          if [ "$COVERAGE_ROUNDED" -lt 75 ]; then
            echo "FAILURE: Coverage ($COVERAGE_ROUNDED%) is below 75% gate."
            exit 1
          fi

          if [ "$TEST_EXIT_CODE" -ne 0 ]; then
            echo "FAILURE: One or more Apex tests failed."
            exit $TEST_EXIT_CODE
          fi

          echo "SUCCESS: Coverage met and tests passed."

      - name: Run Validation Deploy (Fallback Mode)
        if: env.ORG_TYPE == 'fallback'
        run: |
          echo "Running Validation Deployment against Dev Hub (No Scratch Org available)"

          sf project deploy start \
            --target-org devhub \
            --source-dir packages/shared-modules/main/default \
            --source-dir packages/integration-api/main/default \
            --source-dir packages/portfolio-site/main/default \
            --dry-run \
            --test-level RunLocalTests \
            --wait 30

      # ------------------------------------------------------------------
      # 6. Teardown
      # ------------------------------------------------------------------
      - name: Delete Scratch Org
        if: always() && env.ORG_TYPE == 'scratch'
        run: sf org delete scratch --target-org ci-org --no-prompt || true
