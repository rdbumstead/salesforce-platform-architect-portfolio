name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"
      - "package.json"

jobs:
  # JOB 1: Fast Quality Gates
  # Skips on 'labeled' events to avoid redundant scanning when you just want to keep the org alive
  quality-check:
    if: github.event.action != 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - name: Run Quality Gates
        run: |
          npm run scan:secrets
          npm run test:unit
          npm run docs:verify

  # JOB 2: Salesforce Integration
  scratch-org-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Delta generation in Fallback mode

      - name: Setup Salesforce & Tools
        uses: ./.github/actions/setup-sf
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_USERNAME }}
          is_dev_hub: "true"
          install_code_analyzer: "false"

      - name: Create Scratch Org
        id: create_org
        run: |
          echo "ORG_TYPE=scratch" >> $GITHUB_ENV
          set +e
          # Attempt to create scratch org. If it fails (limit reached), we catch the exit code.
          # We capture JSON output to easily parse the Auth URL later.
          sf org create scratch --target-dev-hub portfolio --definition-file config/project-scratch-def.json --alias ci-org --duration-days 1 --set-default --no-ancestors --wait 30 --json > scratch_info.json
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
             echo "Scratch Org limit reached. Switching to Fallback Mode."
             echo "ORG_TYPE=fallback" >> $GITHUB_ENV
          else
             echo "Scratch Org created successfully."
          fi

      # STRATEGY: FULL DEPLOY
      # Scratch orgs start empty, so we must deploy the entire codebase to ensure dependencies exist.
      - name: Deploy & Test (Scratch Mode - FULL)
        if: env.ORG_TYPE == 'scratch'
        run: |
          # 1. Full Deploy
          sf project deploy start --source-dir packages --target-org ci-org --wait 30

          # 2. Run All Tests
          sf apex run test --target-org ci-org --code-coverage --result-format human --wait 20

      # STRATEGY: DELTA VALIDATION
      # If we fallback to the Persistent Org (Prod/Portfolio), we must use Delta to avoid overwriting unrelated metadata.
      - name: Deploy & Test (Fallback Mode - DELTA)
        if: env.ORG_TYPE == 'fallback'
        run: |
          mkdir -p changed
          # Generate delta between PR branch (HEAD) and the target branch (base_ref/main)
          sf sgd source delta --to "HEAD" --from "origin/${{ github.base_ref }}" --output changed --source packages --generate-delta

          # Only run validation if actual metadata changed
          if [ -s changed/package/package.xml ] && grep -q "<types>" changed/package/package.xml; then
             echo "Validating Delta changes against Production..."
             sf project deploy start --target-org portfolio --manifest changed/package/package.xml --dry-run --test-level RunLocalTests --wait 30
          else
             echo "No metadata changes detected. Skipping validation."
          fi

      - name: Provide Instant Access (If Label Applied)
        if: env.ORG_TYPE == 'scratch' && contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: |
          # Extract the Auth URL from the earlier JSON output
          cat scratch_info.json | jq -r .result.authFields.sfdxAuthUrl > auth_url.txt
          AUTH_URL=$(cat auth_url.txt)

          echo "### UAT Environment Ready" >> $GITHUB_STEP_SUMMARY
          echo "> **Status:** Org preserved for 24 hours." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "echo '${AUTH_URL}' > uat_auth.txt" >> $GITHUB_STEP_SUMMARY
          echo "sf org login sfdx-url -f uat_auth.txt --set-alias pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "sf org open -o pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Delete Scratch Org
        # Always delete unless the 'debug:keep-org' label is present
        if: always() && env.ORG_TYPE == 'scratch' && !contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: sf org delete scratch --target-org ci-org --no-prompt || true
