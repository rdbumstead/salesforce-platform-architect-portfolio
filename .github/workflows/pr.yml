name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"

jobs:
  validate-scratch-org:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # ------------------------------------------------------------------
      # 1. Setup Node and Run LWC Tests
      # ------------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install NPM Dependencies
        run: npm ci

      - name: Run LWC Jest Tests
        run: npm run test:unit

      # ------------------------------------------------------------------
      # 2. Salesforce CLI & Code Analyzer
      # ------------------------------------------------------------------
      - name: Install Salesforce CLI
        run: npm install @salesforce/cli --global

      - name: Install Code Analyzer
        run: sf plugins install @salesforce/plugin-code-analyzer

      - name: Authenticate Dev Hub
        run: |
          echo "${{ secrets.SFDX_JWT_KEY }}" > portfolio.key
          sf org login jwt \
            --client-id ${{ secrets.SFDX_CLIENT_ID }} \
            --jwt-key-file portfolio.key \
            --username ${{ secrets.SFDX_USERNAME }} \
            --set-default-dev-hub \
            --alias devhub

      # ------------------------------------------------------------------
      # 3. Static Analysis
      # ------------------------------------------------------------------
      - name: Resolve valid Salesforce analyzer targets
        id: resolve-targets
        shell: bash
        run: |
          POTENTIAL_TARGETS=$(find packages -type d -path "*/main/default")
          TARGETS=""
          for dir in $POTENTIAL_TARGETS; do
            # Check if directory has any files not ignored (e.g., exclude jsconfig.json, .eslintrc.json per .forceignore)
            if [ $(find "$dir" -type f ! -name "jsconfig.json" ! -name ".eslintrc.json" | wc -l) -gt 0 ]; then
              if [ -z "$TARGETS" ]; then
                TARGETS="$dir"
              else
                TARGETS="$TARGETS,$dir"
              fi
            fi
          done
          if [ -z "$TARGETS" ]; then
            echo "No valid main/default directories with scannable files found. Falling back to scanning all packages."
            TARGETS="packages"
          fi
          echo "Resolved targets: $TARGETS"
          echo "targets=$TARGETS" >> $GITHUB_OUTPUT

      - name: Debug Directory Structure and CLI Version
        shell: bash
        run: |
          echo "Listing packages directory structure:"
          ls -R packages
          echo "Salesforce CLI version:"
          sf version --verbose
          sf plugins --core

      - name: Reinstall Code Analyzer Plugin
        shell: bash
        run: |
          sf plugins uninstall code-analyzer || true  # Ignore if not installed
          sf plugins install code-analyzer@latest

      - name: Run Salesforce Code Analyzer
        shell: bash
        run: |
          sf code-analyzer run \
            --target "${{ steps.resolve-targets.outputs.targets }}" \
            --rule-selector pmd:PortfolioSecurityRules \
            --severity-threshold 2 \
            --loglevel trace  # For detailed error logs

      # ------------------------------------------------------------------
      # 4. Scratch Org Execution
      # ------------------------------------------------------------------
      - name: Create Scratch Org
        run: |
          sf org create scratch \
            --target-dev-hub devhub \
            --definition-file config/project-scratch-def.json \
            --alias ci-org \
            --duration-days 1 \
            --set-default \
            --no-ancestors \
            --wait 10

      - name: Push Full Source
        run: sf project deploy start --target-org ci-org

      - name: Assign Permissions
        run: |
          sf org assign permset --name Portfolio_Admin --target-org ci-org

      # ------------------------------------------------------------------
      # 5. Quality Gates (Apex Tests)
      # ------------------------------------------------------------------
      - name: Run Apex Tests
        run: |
          sf apex run test \
            --target-org ci-org \
            --code-coverage \
            --result-format human \
            --wait 10

      # ------------------------------------------------------------------
      # 6. Teardown
      # ------------------------------------------------------------------
      - name: Delete Scratch Org
        if: always()
        run: sf org delete scratch --target-org ci-org --no-prompt || true
