name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"
      - "package.json"

jobs:
  quality-check:
    if: github.event.action != 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment & Scanner
        uses: rdbumstead/setup-salesforce-action@v2
        with:
          skip_auth: "true"
          install_scanner: "true"

      - name: Install Dependencies
        run: npm ci

      - name: Run Quality Gates
        run: |
          npm run scan:secrets
          npm run test:unit
          npm run docs:verify

      - name: Run Salesforce Code Analyzer
        run: |
          sf scanner run --target "packages/**" --format "table" --severity-threshold 3

  scratch-org-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Salesforce & Tools
        uses: rdbumstead/setup-salesforce-action@v1
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_USERNAME }}
          is_dev_hub: "true"
          install_delta: "true"
          alias: "portfolio"

      - name: Create Scratch Org
        id: create_org
        run: |
          echo "ORG_TYPE=scratch" >> $GITHUB_ENV
          set +e
          sf org create scratch --target-dev-hub portfolio --definition-file config/project-scratch-def.json --alias ci-org --duration-days 1 --set-default --no-ancestors --wait 30 --json > scratch_info.json
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
             echo "Scratch Org limit reached. Switching to Fallback Mode."
             echo "ORG_TYPE=fallback" >> $GITHUB_ENV
          else
             echo "Scratch Org created successfully."
          fi

      - name: Deploy & Test (Scratch Mode - FULL)
        if: env.ORG_TYPE == 'scratch'
        run: |
          sf project deploy start --source-dir packages --target-org ci-org --wait 30

          sf apex run test --target-org ci-org --code-coverage --result-format human --wait 20

      - name: Deploy & Test (Fallback Mode - DELTA)
        if: env.ORG_TYPE == 'fallback'
        run: |
          mkdir -p changed
          sf sgd source delta --to "HEAD" --from "origin/${{ github.base_ref }}" --output changed --source packages --generate-delta

          if [ -s changed/package/package.xml ] && grep -q "<types>" changed/package/package.xml; then
             echo "Validating Delta changes against Production..."
             sf project deploy start --target-org portfolio --manifest changed/package/package.xml --dry-run --test-level RunLocalTests --wait 30
          else
             echo "No metadata changes detected. Skipping validation."
          fi

      - name: Provide Instant Access (If Label Applied)
        if: env.ORG_TYPE == 'scratch' && contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: |
          cat scratch_info.json | jq -r .result.authFields.sfdxAuthUrl > auth_url.txt
          AUTH_URL=$(cat auth_url.txt)

          echo "### UAT Environment Ready" >> $GITHUB_STEP_SUMMARY
          echo "> **Status:** Org preserved for 24 hours." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "echo '${AUTH_URL}' > uat_auth.txt" >> $GITHUB_STEP_SUMMARY
          echo "sf org login sfdx-url -f uat_auth.txt --set-alias pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "sf org open -o pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Delete Scratch Org
        if: always() && env.ORG_TYPE == 'scratch' && !contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: sf org delete scratch --target-org ci-org --no-prompt || true
