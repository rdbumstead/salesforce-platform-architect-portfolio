name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"
      - "package.json"
      - "package-lock.json"
      - "scripts/**"
      - ".github/workflows/pr.yml"
      - ".github/actions/**"
    paths-ignore:
      - "packages/**/*.md"
      - "packages/**/jsconfig.json"
      - "packages/**/.gitkeep"
      - "packages/integration-api/AnypointStudio/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install NPM Dependencies
        run: npm ci

      - name: Setup Salesforce & Tools
        uses: ./.github/actions/setup-sf
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_USERNAME }}
          is_dev_hub: "true"

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run Quality Gates
        run: |
          npm run scan:secrets
          npm run test:unit
          npm run scan
          npm run docs:verify

      - name: Run Lighthouse Performance Audit
        run: npm run test:lighthouse || echo "Lighthouse failed assertion, but continuing build."
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Create Scratch Org or Fallback
        id: create_org
        run: |
          echo "ORG_TYPE=scratch" >> $GITHUB_ENV
          set +e
          # Target the 'portfolio' alias established in the composite action
          OUTPUT=$(sf org create scratch --target-dev-hub portfolio --definition-file config/project-scratch-def.json --alias ci-org --duration-days 1 --set-default --no-ancestors --wait 30 --json 2>&1)
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ] && echo "$OUTPUT" | grep -q "LIMIT_EXCEEDED"; then
             echo "Scratch Org limit reached. Switching to Fallback Mode."
             echo "ORG_TYPE=fallback" >> $GITHUB_ENV
          fi

      - name: Deploy & Test (Scratch Mode)
        if: env.ORG_TYPE == 'scratch'
        run: |
          sf project deploy start --source-dir packages --target-org ci-org --wait 30
          sf apex run test --target-org ci-org --code-coverage --result-format human --wait 10

      - name: Deploy & Test (Fallback Mode)
        if: env.ORG_TYPE == 'fallback'
        run: |
          sf project deploy start --target-org portfolio --source-dir packages --dry-run --test-level RunLocalTests --wait 30

      - name: Delete Scratch Org
        if: always() && env.ORG_TYPE == 'scratch'
        run: sf org delete scratch --target-org ci-org --no-prompt || true
