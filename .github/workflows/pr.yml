name: Validate PR (Scratch Org)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]
    paths:
      - "packages/**"
      - "sfdx-project.json"
      - "package.json"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install NPM Dependencies
        run: npm ci

      - name: Setup Salesforce & Tools
        uses: ./.github/actions/setup-sf
        with:
          jwt_key: ${{ secrets.SFDX_JWT_KEY }}
          client_id: ${{ secrets.SFDX_CLIENT_ID }}
          username: ${{ secrets.SFDX_USERNAME }}
          is_dev_hub: "true"

      - name: Run Quality Gates
        run: |
          npm run scan:secrets
          npm run test:unit
          npm run scan
          npm run docs:verify

      - name: Create Scratch Org
        id: create_org
        run: |
          echo "ORG_TYPE=scratch" >> $GITHUB_ENV
          set +e
          # Duration set to 1 day to ensure auto-cleanup if delete is skipped
          OUTPUT=$(sf org create scratch --target-dev-hub portfolio --definition-file config/project-scratch-def.json --alias ci-org --duration-days 1 --set-default --no-ancestors --wait 30 --json 2>&1)
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ]; then
             echo "Scratch Org limit reached. Switching to Fallback Mode."
             echo "ORG_TYPE=fallback" >> $GITHUB_ENV
          fi

      - name: Deploy & Test (Scratch Mode)
        if: env.ORG_TYPE == 'scratch'
        run: |
          sf project deploy start --source-dir packages --target-org ci-org --wait 30
          sf apex run test --target-org ci-org --code-coverage --result-format human --wait 10

      - name: Deploy & Test (Fallback Mode)
        if: env.ORG_TYPE == 'fallback'
        run: |
          # Dry-run against Prod (Portfolio) if Scratch limit hit
          sf project deploy start --target-org portfolio --source-dir packages --dry-run --test-level RunLocalTests --wait 30

      - name: Provide Instant Access (If Label Applied)
        if: env.ORG_TYPE == 'scratch' && contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: |
          # 1. Extract the Auth URL safely
          sf org display --target-org ci-org --verbose --json | jq -r .result.sfdxAuthUrl > auth_url.txt
          AUTH_URL=$(cat auth_url.txt)

          # 2. Generate the Developer Summary
          echo "### UAT Environment Ready" >> $GITHUB_STEP_SUMMARY
          echo "> **Status:** Org preserved for 24 hours." >> $GITHUB_STEP_SUMMARY
          echo "> **Action:** Copy and run the block below to launch the org locally." >> $GITHUB_STEP_SUMMARY

          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# 1. Create temporary auth file" >> $GITHUB_STEP_SUMMARY
          echo "echo '${AUTH_URL}' > uat_auth.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. Authenticate & Open" >> $GITHUB_STEP_SUMMARY
          echo "sf org login sfdx-url -f uat_auth.txt --set-alias pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "sf org open -o pr-${{ github.event.number }}-uat" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 3. Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "rm uat_auth.txt" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Delete Scratch Org
        if: always() && env.ORG_TYPE == 'scratch' && !contains(github.event.pull_request.labels.*.name, 'debug:keep-org')
        run: sf org delete scratch --target-org ci-org --no-prompt || true
